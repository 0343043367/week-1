name: Deploy to AKS

on:
  push:
    branches:
      - main # Auto deploy when push to main branch
  workflow_dispatch: # Also allow manual trigger

env:
  ACR_NAME: mindxtulmacr
  AKS_CLUSTER: mindx-tulm-aks
  RESOURCE_GROUP: mindx-tulm-rg
  APP_DOMAIN: tulm.mindx.edu.vn

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # Extract version from tag
      - name: Get version from tag
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/}
          else
            VERSION=${{ github.sha }}
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Deploying version: $VERSION"

      # Login to Azure
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # Login to ACR
      - name: Login to Azure Container Registry
        run: az acr login --name ${{ env.ACR_NAME }}

      # Build and Push API Image
      - name: Build API Docker Image
        run: |
          docker build -t ${{ env.ACR_NAME }}.azurecr.io/mindx-week1-api:${{ steps.version.outputs.VERSION }} \
                       -t ${{ env.ACR_NAME }}.azurecr.io/mindx-week1-api:latest \
                       ./api

      - name: Push API Image to ACR
        run: |
          docker push ${{ env.ACR_NAME }}.azurecr.io/mindx-week1-api:${{ steps.version.outputs.VERSION }}
          docker push ${{ env.ACR_NAME }}.azurecr.io/mindx-week1-api:latest

      # Build and Push Frontend Image
      - name: Build Frontend Docker Image
        run: |
          docker build -t ${{ env.ACR_NAME }}.azurecr.io/mindx-week1-frontend:${{ steps.version.outputs.VERSION }} \
                       -t ${{ env.ACR_NAME }}.azurecr.io/mindx-week1-frontend:latest \
                       ./frontend

      - name: Push Frontend Image to ACR
        run: |
          docker push ${{ env.ACR_NAME }}.azurecr.io/mindx-week1-frontend:${{ steps.version.outputs.VERSION }}
          docker push ${{ env.ACR_NAME }}.azurecr.io/mindx-week1-frontend:latest

      # Deploy to AKS
      - name: Set AKS Context
        run: |
          az aks get-credentials --name ${{ env.AKS_CLUSTER }} --resource-group ${{ env.RESOURCE_GROUP }} --overwrite-existing

      - name: Deploy API to AKS
        run: |
          kubectl set image deployment/mindx-api api=${{ env.ACR_NAME }}.azurecr.io/mindx-week1-api:${{ steps.version.outputs.VERSION }} --record
          kubectl rollout status deployment/mindx-api --timeout=300s

      - name: Deploy Frontend to AKS
        run: |
          kubectl set image deployment/mindx-frontend frontend=${{ env.ACR_NAME }}.azurecr.io/mindx-week1-frontend:${{ steps.version.outputs.VERSION }} --record
          kubectl rollout status deployment/mindx-frontend --timeout=300s

      # Verify Deployment
      - name: Verify Deployment
        run: |
          echo "Checking deployment status..."
          kubectl get deployments
          kubectl get pods
          kubectl get ingress

      - name: Test Application Health
        run: |
          echo "Testing application health..."
          sleep 15
          # Test health endpoint through the domain
          curl -f https://${{ env.APP_DOMAIN }}/health || echo "Health check failed, but continuing..."
          echo "âœ… Deployment completed!"

      # Notification
      - name: Deployment Summary
        if: success()
        run: |
          echo "ðŸŽ‰ Deployment Successful!"
          echo "Frontend: https://${{ env.APP_DOMAIN }}/"
          echo "API: https://${{ env.APP_DOMAIN }}/api"
          echo "Health: https://${{ env.APP_DOMAIN }}/health"
          echo "Version: ${{ steps.version.outputs.VERSION }}"
